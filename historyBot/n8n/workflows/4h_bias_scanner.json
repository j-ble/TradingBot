{
  "name": "4H Bias Scanner",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "hoursInterval": 4
            }
          ]
        }
      },
      "name": "Every 4 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300],
      "id": "trigger-4h"
    },
    {
      "parameters": {
        "functionCode": "// Load environment variables\nconst apiKey = $env.COINBASE_API_KEY;\nconst apiSecret = $env.COINBASE_API_SECRET;\n\n// Coinbase Advanced Trade API endpoint\nconst product = 'BTC-USD';\nconst granularity = 'FOUR_HOUR';\nconst limit = 50; // Get 50 candles for swing detection + RSI\n\nconst timestamp = Math.floor(Date.now() / 1000);\n\n// Create JWT for authentication\nconst crypto = require('crypto');\nconst method = 'GET';\nconst path = `/api/v3/brokerage/products/${product}/candles?granularity=${granularity}&limit=${limit}`;\n\nconst payload = {\n  iss: 'coinbase-cloud',\n  nbf: timestamp,\n  exp: timestamp + 120,\n  sub: apiKey,\n  uri: method + ' ' + path\n};\n\nconst header = {\n  alg: 'ES256',\n  kid: apiKey,\n  nonce: crypto.randomBytes(16).toString('hex')\n};\n\nconst jwt = require('jsonwebtoken');\nconst token = jwt.sign(payload, apiSecret, {\n  algorithm: 'ES256',\n  header: header\n});\n\nreturn {\n  url: `https://api.coinbase.com${path}`,\n  token: token\n};"
      },
      "name": "Prepare Coinbase Request",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300],
      "id": "prepare-request"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.token }}"
            }
          ]
        }
      },
      "name": "Fetch 4H Candles",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 300],
      "id": "fetch-candles"
    },
    {
      "parameters": {
        "functionCode": "// Parse Coinbase response and calculate RSI\nconst candles = $input.first().json.candles;\n\n// Sort by timestamp (oldest first)\nconst sortedCandles = candles.sort((a, b) => parseInt(a.start) - parseInt(b.start));\n\n// Transform to OHLCV format\nconst ohlcv = sortedCandles.map(c => ({\n  timestamp: new Date(parseInt(c.start) * 1000),\n  open: parseFloat(c.open),\n  high: parseFloat(c.high),\n  low: parseFloat(c.low),\n  close: parseFloat(c.close),\n  volume: parseFloat(c.volume)\n}));\n\n// Calculate RSI (14 period)\nfunction calculateRSI(data, period = 14) {\n  if (data.length < period + 1) return null;\n  \n  let gains = 0;\n  let losses = 0;\n  \n  // Initial average gain/loss\n  for (let i = 1; i <= period; i++) {\n    const change = data[i].close - data[i - 1].close;\n    if (change >= 0) {\n      gains += change;\n    } else {\n      losses += Math.abs(change);\n    }\n  }\n  \n  let avgGain = gains / period;\n  let avgLoss = losses / period;\n  \n  // Calculate RSI for remaining data\n  const rsi = [];\n  \n  for (let i = period; i < data.length; i++) {\n    const change = data[i].close - data[i - 1].close;\n    const gain = change >= 0 ? change : 0;\n    const loss = change < 0 ? Math.abs(change) : 0;\n    \n    avgGain = ((avgGain * (period - 1)) + gain) / period;\n    avgLoss = ((avgLoss * (period - 1)) + loss) / period;\n    \n    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;\n    const rsiValue = 100 - (100 / (1 + rs));\n    \n    rsi.push({\n      timestamp: data[i].timestamp,\n      value: rsiValue\n    });\n  }\n  \n  return rsi;\n}\n\n// Detect swing highs and lows (3-candle pattern)\nfunction detectSwings(data) {\n  const swings = [];\n  \n  for (let i = 2; i < data.length; i++) {\n    const prev2 = data[i - 2];\n    const prev1 = data[i - 1];\n    const curr = data[i];\n    \n    // Swing High: middle candle high > both neighbors\n    if (prev1.high > prev2.high && prev1.high > curr.high) {\n      swings.push({\n        type: 'HIGH',\n        price: prev1.high,\n        timestamp: prev1.timestamp,\n        index: i - 1\n      });\n    }\n    \n    // Swing Low: middle candle low < both neighbors\n    if (prev1.low < prev2.low && prev1.low < curr.low) {\n      swings.push({\n        type: 'LOW',\n        price: prev1.low,\n        timestamp: prev1.timestamp,\n        index: i - 1\n      });\n    }\n  }\n  \n  return swings;\n}\n\nconst rsiData = calculateRSI(ohlcv);\nconst swings = detectSwings(ohlcv);\n\n// Get latest candle and previous candle\nconst latestCandle = ohlcv[ohlcv.length - 1];\nconst prevCandle = ohlcv[ohlcv.length - 2];\nconst latestRSI = rsiData && rsiData.length > 0 ? rsiData[rsiData.length - 1].value : null;\n\nreturn {\n  candles: ohlcv,\n  latestCandle,\n  prevCandle,\n  latestRSI,\n  swings\n};"
      },
      "name": "Calculate RSI & Swings",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 300],
      "id": "calculate-indicators"
    },
    {
      "parameters": {
        "functionCode": "// Implement 4H Bias Contract Logic\nconst { latestCandle, prevCandle, latestRSI, swings } = $input.first().json;\n\nif (!latestRSI || swings.length === 0) {\n  return { noSignal: true, reason: 'Insufficient data' };\n}\n\n// Get most recent swing high and low\nconst recentSwingHigh = swings.filter(s => s.type === 'HIGH').pop();\nconst recentSwingLow = swings.filter(s => s.type === 'LOW').pop();\n\nlet biasDetected = null;\n\n// BULLISH BIAS CHECK\nif (recentSwingLow) {\n  // 1. LOW swept: wick below swing low, close above\n  const lowSwept = prevCandle.low < recentSwingLow.price && prevCandle.close > recentSwingLow.price;\n  \n  // 2. RSI < 40 at sweep candle\n  const rsiCondition = latestRSI < 40;\n  \n  // 3. Next 4H candle closes HIGHER than sweep candle\n  const confirmationCandle = latestCandle.close > prevCandle.close;\n  \n  if (lowSwept && rsiCondition && confirmationCandle) {\n    biasDetected = {\n      bias: 'BULLISH',\n      sweepType: 'LOW',\n      sweepPrice: recentSwingLow.price,\n      sweepCandleClose: prevCandle.close,\n      confirmationCandleClose: latestCandle.close,\n      rsi: latestRSI,\n      timestamp: latestCandle.timestamp\n    };\n  }\n}\n\n// BEARISH BIAS CHECK\nif (!biasDetected && recentSwingHigh) {\n  // 1. HIGH swept: wick above swing high, close below\n  const highSwept = prevCandle.high > recentSwingHigh.price && prevCandle.close < recentSwingHigh.price;\n  \n  // 2. RSI > 80 at sweep candle\n  const rsiCondition = latestRSI > 80;\n  \n  // 3. Next 4H candle closes LOWER than sweep candle\n  const confirmationCandle = latestCandle.close < prevCandle.close;\n  \n  if (highSwept && rsiCondition && confirmationCandle) {\n    biasDetected = {\n      bias: 'BEARISH',\n      sweepType: 'HIGH',\n      sweepPrice: recentSwingHigh.price,\n      sweepCandleClose: prevCandle.close,\n      confirmationCandleClose: latestCandle.close,\n      rsi: latestRSI,\n      timestamp: latestCandle.timestamp\n    };\n  }\n}\n\nif (biasDetected) {\n  return { signalDetected: true, ...biasDetected };\n} else {\n  return { noSignal: true, reason: 'No bias conditions met', rsi: latestRSI };\n}"
      },
      "name": "Detect 4H Bias",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 300],
      "id": "detect-bias"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.signalDetected }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Signal Detected?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1250, 300],
      "id": "check-signal"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO liquidity_sweeps (timestamp, sweep_type, price, bias, swing_level, active)\nVALUES (\n  '{{ $json.timestamp }}',\n  '{{ $json.sweepType }}',\n  {{ $json.sweepCandleClose }},\n  '{{ $json.bias }}',\n  {{ $json.sweepPrice }},\n  true\n)\nRETURNING id;",
        "options": {}
      },
      "name": "Store Bias in DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1450, 200],
      "id": "store-bias",
      "credentials": {
        "postgres": {
          "id": "postgres-trading-bot",
          "name": "PostgreSQL - Trading Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "=ðŸ”µ *4H {{ $json.bias }} BIAS DETECTED*\n\nðŸ“Š Sweep: {{ $json.sweepType }} @ ${{ $json.sweepPrice.toFixed(2) }}\nðŸ“ˆ RSI: {{ $json.rsi.toFixed(1) }}\nâœ… Confirmation: ${{ $json.confirmationCandleClose.toFixed(2) }}\nâ° Time: {{ $json.timestamp }}\n\nâž¡ï¸ _Monitoring 5M for reclaim level..._",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "name": "Send Telegram Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1450, 400],
      "id": "telegram-alert",
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Log no signal for monitoring\nconst { noSignal, reason, rsi } = $input.first().json;\nconsole.log(`4H Scanner: ${reason} (RSI: ${rsi?.toFixed(1) || 'N/A'})`);\nreturn { logged: true };"
      },
      "name": "Log No Signal",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1450, 600],
      "id": "log-no-signal"
    }
  ],
  "connections": {
    "Every 4 Hours": {
      "main": [
        [
          {
            "node": "Prepare Coinbase Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Coinbase Request": {
      "main": [
        [
          {
            "node": "Fetch 4H Candles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch 4H Candles": {
      "main": [
        [
          {
            "node": "Calculate RSI & Swings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate RSI & Swings": {
      "main": [
        [
          {
            "node": "Detect 4H Bias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect 4H Bias": {
      "main": [
        [
          {
            "node": "Signal Detected?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Signal Detected?": {
      "main": [
        [
          {
            "node": "Store Bias in DB",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Telegram Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log No Signal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-12-17T00:00:00.000Z",
  "versionId": "1"
}
